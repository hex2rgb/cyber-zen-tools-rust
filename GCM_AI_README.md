# GCM-AI å‘½ä»¤å®ç°è¯¦è§£

## ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
3. [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)
4. [æ¨¡å‹æ–‡ä»¶ç»“æ„](#æ¨¡å‹æ–‡ä»¶ç»“æ„)
5. [å·¥ä½œæµç¨‹](#å·¥ä½œæµç¨‹)
6. [æŠ€æœ¯åŸç†](#æŠ€æœ¯åŸç†)
7. [åè¯è§£é‡Š](#åè¯è§£é‡Š)
8. [ä½¿ç”¨æŒ‡å—](#ä½¿ç”¨æŒ‡å—)
9. [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤)

---

## æ¦‚è¿°

`gcm-ai` æ˜¯ä¸€ä¸ª AI å¢å¼ºçš„ Git æäº¤å·¥å…·ï¼Œå®ƒä½¿ç”¨æœ¬åœ°å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰è‡ªåŠ¨ç”Ÿæˆç¬¦åˆ Conventional Commits è§„èŒƒçš„ commit messageã€‚

### æ ¸å¿ƒç‰¹æ€§

- âœ… **æœ¬åœ°æ¨ç†**ï¼šå®Œå…¨åœ¨æœ¬åœ°è¿è¡Œï¼Œæ— éœ€ç½‘ç»œè¿æ¥
- âœ… **æ™ºèƒ½åˆ†æ**ï¼šè‡ªåŠ¨åˆ†æ Git å˜æ›´å¹¶ç”Ÿæˆåˆé€‚çš„ commit message
- âœ… **å†å²é‡å†™**ï¼šæ”¯æŒæ‰¹é‡é‡å†™å†å²æäº¤çš„ commit message
- âœ… **æ¨¡å‹ç®¡ç†**ï¼šçµæ´»çš„æ¨¡å‹æ–‡ä»¶ç®¡ç†æœºåˆ¶

### æŠ€æœ¯æ ˆ

- **Rust**ï¼šé«˜æ€§èƒ½ç³»ç»Ÿç¼–ç¨‹è¯­è¨€
- **Candle**ï¼šçº¯ Rust å®ç°çš„æœºå™¨å­¦ä¹ æ¡†æ¶
- **Qwen2.5-Coder-0.5B-Instruct**ï¼šä¸“é—¨ç”¨äºä»£ç ç†è§£çš„è½»é‡çº§æ¨¡å‹ï¼ˆçº¦ 988MBï¼‰

---

## æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    gcm-ai å‘½ä»¤å…¥å£                           â”‚
â”‚                  (gcm_ai.rs::run_gcm_ai)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                               â”‚
        â–¼                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ–°æäº¤æ¨¡å¼    â”‚              â”‚  å†å²é‡å†™æ¨¡å¼  â”‚
â”‚ (generate)    â”‚              â”‚  (rewrite)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                               â”‚
        â–¼                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Git å˜æ›´åˆ†ææ¨¡å—                          â”‚
â”‚    (analyze_git_changes, display_changes)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Prompt æ„å»ºæ¨¡å—                          â”‚
â”‚    (build_commit_prompt, build_rewrite_prompt)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Candle æ¨¡å‹æ¨ç†æ¨¡å—                       â”‚
â”‚         (candle_model.rs)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  1. æ¨¡å‹åŠ è½½ (load_from_path)             â”‚   â”‚
â”‚  â”‚  2. Tokenization (tokenizer)             â”‚   â”‚
â”‚  â”‚  3. æ¨¡å‹æ¨ç† (model.forward)              â”‚   â”‚
â”‚  â”‚  4. æ–‡æœ¬ç”Ÿæˆ (generate)                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Git æ“ä½œæ‰§è¡Œæ¨¡å—                          â”‚
â”‚    (exec_git_command, check_git_repo)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¨¡å—èŒè´£åˆ’åˆ†

1. **gcm_ai.rs**ï¼šä¸»æ§åˆ¶é€»è¾‘
   - å‘½ä»¤è¡Œå‚æ•°è§£æ
   - å·¥ä½œæµç¨‹ç¼–æ’
   - Git æ“ä½œæ‰§è¡Œ

2. **candle_model.rs**ï¼šæ¨¡å‹æ¨ç†å¼•æ“
   - æ¨¡å‹æ–‡ä»¶åŠ è½½
   - Token ç¼–ç /è§£ç 
   - ç¥ç»ç½‘ç»œæ¨ç†

3. **config æ¨¡å—**ï¼šé…ç½®ç®¡ç†
   - æ–‡ä»¶ç±»å‹è¯†åˆ«
   - å˜æ›´åˆ†ç±»
   - æ¨¡æ¿ç®¡ç†

---

## æ ¸å¿ƒç»„ä»¶

### 1. gcm_ai.rs æ ¸å¿ƒå‡½æ•°

#### `run_gcm_ai()` - ä¸»å…¥å£å‡½æ•°

**åŠŸèƒ½**ï¼šè§£æå‘½ä»¤è¡Œå‚æ•°ï¼Œå†³å®šæ‰§è¡Œæ¨¡å¼ï¼ˆæ–°æäº¤æˆ–å†å²é‡å†™ï¼‰

**å‚æ•°**ï¼š
- `message: Option<String>` - ç”¨æˆ·æä¾›çš„ commit messageï¼ˆå¯é€‰ï¼‰
- `rewrite: bool` - æ˜¯å¦å¯ç”¨å†å²é‡å†™æ¨¡å¼
- `max_commits: Option<usize>` - é‡å†™æ¨¡å¼ä¸‹çš„æœ€å¤§æäº¤æ•°é‡
- `dry_run: bool` - é¢„è§ˆæ¨¡å¼ï¼ˆä¸å®é™…ä¿®æ”¹ï¼‰
- `model: Option<String>` - æŒ‡å®šä½¿ç”¨çš„æ¨¡å‹åç§°

**æ‰§è¡Œæµç¨‹**ï¼š
```
1. æŸ¥æ‰¾æ¨¡å‹æ–‡ä»¶ (find_model_file)
   â”œâ”€ å¦‚æœæŒ‡å®šäº† --modelï¼ŒæŸ¥æ‰¾å¯¹åº”æ¨¡å‹
   â””â”€ å¦åˆ™æŸ¥æ‰¾ default_* å¼€å¤´çš„é»˜è®¤æ¨¡å‹

2. æ ¹æ® rewrite å‚æ•°é€‰æ‹©æ¨¡å¼
   â”œâ”€ rewrite = false â†’ ç”Ÿæˆæ–°æäº¤
   â”‚   â”œâ”€ å¦‚æœæä¾›äº† messageï¼Œç›´æ¥ä½¿ç”¨
   â”‚   â””â”€ å¦åˆ™è°ƒç”¨ generate_ai_commit_message()
   â”‚       â”œâ”€ åˆ†æ Git å˜æ›´
   â”‚       â”œâ”€ æ„å»º Prompt
   â”‚       â”œâ”€ è°ƒç”¨ AI æ¨¡å‹ç”Ÿæˆ
   â”‚       â””â”€ æ‰§è¡Œ git add/commit/push
   â”‚
   â””â”€ rewrite = true â†’ é‡å†™å†å²æäº¤
       â”œâ”€ è·å–æœ€è¿‘çš„ N ä¸ªæäº¤
       â”œâ”€ å¯¹æ¯ä¸ªæäº¤ç”Ÿæˆæ–°çš„ message
       â””â”€ ä½¿ç”¨ git filter-branch é‡å†™å†å²
```

#### `find_model_file()` - æ¨¡å‹æ–‡ä»¶æŸ¥æ‰¾

**åŠŸèƒ½**ï¼šæ ¹æ®æ¨¡å‹åç§°æˆ–é»˜è®¤è§„åˆ™æŸ¥æ‰¾æ¨¡å‹æ–‡ä»¶

**æŸ¥æ‰¾ä¼˜å…ˆçº§**ï¼š
1. **å‘½ä»¤è¡ŒæŒ‡å®š** (`--model <name>`)
   - å…ˆæŸ¥æ‰¾ `~/.cyber-zen/models/<name>/model.safetensors`
   - å†æŸ¥æ‰¾ `~/.cyber-zen/models/<name>.safetensors`
   - å…¼å®¹æ—§æ ¼å¼ `~/.cyber-zen/models/<name>.gguf`

2. **é»˜è®¤æ¨¡å‹** (æ—  `--model` å‚æ•°)
   - æŸ¥æ‰¾ `~/.cyber-zen/models/default_*/model.safetensors` (ç›®å½•å½¢å¼)
   - æŸ¥æ‰¾ `~/.cyber-zen/models/default_*.safetensors` (æ–‡ä»¶å½¢å¼)

**ä»£ç é€»è¾‘**ï¼š
```rust
fn find_model_file(model_name: Option<String>) -> Result<PathBuf> {
    let model_dir = get_model_dir(); // ~/.cyber-zen/models/
    
    if let Some(name) = model_name {
        // ä¼˜å…ˆçº§ 1: å­ç›®å½•ä¸­çš„ model.safetensors
        let dir_path = model_dir.join(&name);
        let file_in_dir = dir_path.join("model.safetensors");
        if file_in_dir.exists() { return Ok(file_in_dir); }
        
        // ä¼˜å…ˆçº§ 2: ç›´æ¥æ–‡ä»¶
        let path = model_dir.join(format!("{}.safetensors", name));
        if path.exists() { return Ok(path); }
        
        // é”™è¯¯ï¼šæœªæ‰¾åˆ°
        return Err(...);
    }
    
    // æŸ¥æ‰¾ default_* å¼€å¤´çš„æ¨¡å‹
    // ...
}
```

#### `generate_ai_commit_message()` - AI ç”Ÿæˆä¸»å‡½æ•°

**åŠŸèƒ½**ï¼šåˆ†æ Git å˜æ›´å¹¶ç”Ÿæˆ commit message

**æ‰§è¡Œæ­¥éª¤**ï¼š
1. **éªŒè¯ Git ä»“åº“** (`check_git_repo()`)
   - æ‰§è¡Œ `git rev-parse --git-dir` éªŒè¯å½“å‰ç›®å½•æ˜¯ Git ä»“åº“

2. **åŠ è½½é…ç½®ç®¡ç†å™¨** (`FileTypeManager::new()`)
   - ä» `~/.cyber-zen/configs/` åŠ è½½é…ç½®æ–‡ä»¶
   - åŒ…æ‹¬ï¼š`file-types.toml`, `categories.toml`, `commit-templates.toml`

3. **åˆ†æ Git å˜æ›´** (`analyze_git_changes()`)
   - æ‰§è¡Œ `git status --porcelain` è·å–å˜æ›´åˆ—è¡¨
   - è§£ææ¯è¡Œæ ¼å¼ï¼š`XY filename`
     - `X` = æš‚å­˜åŒºçŠ¶æ€ï¼ˆA=æ–°å¢, M=ä¿®æ”¹, D=åˆ é™¤, R=é‡å‘½åï¼‰
     - `Y` = å·¥ä½œåŒºçŠ¶æ€
   - ä¸ºæ¯ä¸ªæ–‡ä»¶åˆ†ç±»ï¼ˆæ ¹æ®ç›®å½•æ¨¡å¼å’Œæ–‡ä»¶æ‰©å±•åï¼‰

4. **æ˜¾ç¤ºå˜æ›´ä¿¡æ¯** (`display_changes()`)
   - æ‰“å°æ–‡ä»¶å˜æ›´åˆ—è¡¨ï¼ˆå¸¦é¢œè‰²å’Œå›¾æ ‡ï¼‰
   - æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯ï¼ˆæ–°å¢/ä¿®æ”¹/åˆ é™¤æ•°é‡ï¼‰

5. **æ„å»º Prompt** (`build_commit_prompt()`)
   - å°† Git å˜æ›´è½¬æ¢ä¸ºè‡ªç„¶è¯­è¨€æè¿°
   - æ·»åŠ  Conventional Commits æ ¼å¼è¦æ±‚

6. **è°ƒç”¨ AI æ¨¡å‹** (`call_local_model()`)
   - åŠ è½½æ¨¡å‹
   - æ‰§è¡Œæ¨ç†
   - è¿”å›ç”Ÿæˆçš„æ–‡æœ¬

7. **ç”¨æˆ·ç¡®è®¤** (`confirm_with_user()`)
   - æ˜¾ç¤ºç”Ÿæˆçš„ message
   - ç­‰å¾…ç”¨æˆ·ç¡®è®¤ï¼ˆY/nï¼‰

#### `analyze_git_changes()` - Git å˜æ›´åˆ†æ

**åŠŸèƒ½**ï¼šè§£æ `git status --porcelain` è¾“å‡ºï¼Œæå–æ–‡ä»¶å˜æ›´ä¿¡æ¯

**Git Porcelain æ ¼å¼**ï¼š
```
XY filename
```

**çŠ¶æ€ç å«ä¹‰**ï¼š
- `X` (æš‚å­˜åŒºçŠ¶æ€)ï¼š
  - ` ` (ç©ºæ ¼) = æ— å˜æ›´
  - `A` = æ–°å¢ (Added)
  - `M` = ä¿®æ”¹ (Modified)
  - `D` = åˆ é™¤ (Deleted)
  - `R` = é‡å‘½å (Renamed)
  - `C` = å¤åˆ¶ (Copied)

- `Y` (å·¥ä½œåŒºçŠ¶æ€)ï¼š
  - ` ` (ç©ºæ ¼) = æ— å˜æ›´
  - `M` = ä¿®æ”¹
  - `D` = åˆ é™¤
  - `T` = ç±»å‹å˜æ›´

**è§£æé€»è¾‘**ï¼š
```rust
for line in git_status_output.lines() {
    let status = line.chars().next().unwrap(); // ç¬¬ä¸€ä¸ªå­—ç¬¦
    let file = line.chars().skip(3).collect::<String>(); // è·³è¿‡ "XY " ä¸‰ä¸ªå­—ç¬¦
    
    // ä½¿ç”¨ FileTypeManager åˆ†ç±»æ–‡ä»¶
    let category = file_type_manager.get_file_category(&file);
    let file_type = file_type_manager.get_file_type(&file);
    
    changes.push(ChangeInfo {
        file,
        status,
        category,  // ä¾‹å¦‚: "å‰ç«¯", "åç«¯", "é…ç½®"
        file_type, // ä¾‹å¦‚: "Rust æºæ–‡ä»¶", "é…ç½®æ–‡ä»¶"
    });
}
```

#### `build_commit_prompt()` - Prompt æ„å»º

**åŠŸèƒ½**ï¼šå°† Git å˜æ›´è½¬æ¢ä¸ºæ¨¡å‹å¯ç†è§£çš„ Prompt

**Prompt ç»“æ„**ï¼š
```
æ ¹æ®ä»¥ä¸‹ Git å˜æ›´ï¼Œç”Ÿæˆä¸€ä¸ªç¬¦åˆ Conventional Commits è§„èŒƒçš„ commit messageã€‚

å˜æ›´å†…å®¹ï¼š
- æ–°å¢ src/commands/gcm_ai.rs (åç«¯)
- ä¿®æ”¹ src/main.rs (åç«¯)
- åˆ é™¤ old_file.rs (åç«¯)

è¦æ±‚ï¼š
1. ä½¿ç”¨ä¸­æ–‡
2. æ ¼å¼ï¼š<type>: <description>
3. type å¯ä»¥æ˜¯ï¼šfeat, fix, refactor, style, docs, test, chore, perf, cleanup
4. description è¦ç®€æ´æ˜äº†ï¼Œæè¿°ä¸»è¦å˜æ›´
5. åªè¿”å› commit messageï¼Œä¸è¦å…¶ä»–è¯´æ˜
```

**æ„å»ºé€»è¾‘**ï¼š
```rust
fn build_commit_prompt(changes: &[ChangeInfo]) -> String {
    let mut prompt = String::from("æ ¹æ®ä»¥ä¸‹ Git å˜æ›´...");
    
    for change in changes {
        let action = match change.status.as_str() {
            "A" => "æ–°å¢",
            "M" => "ä¿®æ”¹",
            "D" => "åˆ é™¤",
            "R" => "é‡å‘½å",
            _ => "å˜æ›´",
        };
        prompt.push_str(&format!(
            "- {} {} ({})\n",
            action,      // æ“ä½œç±»å‹
            change.file, // æ–‡ä»¶è·¯å¾„
            change.category // æ–‡ä»¶åˆ†ç±»
        ));
    }
    
    prompt.push_str("\nè¦æ±‚ï¼š\n...");
    prompt
}
```

#### `call_local_model()` - æ¨¡å‹è°ƒç”¨å°è£…

**åŠŸèƒ½**ï¼šå°è£…æ¨¡å‹åŠ è½½å’Œæ¨ç†è¿‡ç¨‹ï¼Œæä¾›ç»Ÿä¸€çš„è°ƒç”¨æ¥å£

**æ‰§è¡Œæµç¨‹**ï¼š
```rust
fn call_local_model(model_path: &PathBuf, prompt: &str) -> Result<String> {
    // 1. åŠ è½½æ¨¡å‹
    let mut model = CandleModel::load_from_path(model_path)?;
    
    // 2. ç”Ÿæˆæ–‡æœ¬ï¼ˆæœ€å¤§ 200 tokensï¼‰
    let output = model.generate(prompt, 200)?;
    
    // 3. éªŒè¯è¾“å‡ºæ ¼å¼
    if !output.contains(':') {
        // å¦‚æœæ²¡æœ‰å†’å·ï¼Œæ·»åŠ é»˜è®¤ç±»å‹å‰ç¼€
        return Ok(format!("feat: {}", output));
    }
    
    Ok(output)
}
```

#### `rewrite_commit_history()` - å†å²é‡å†™

**åŠŸèƒ½**ï¼šæ‰¹é‡é‡å†™å†å²æäº¤çš„ commit message

**æ‰§è¡Œæµç¨‹**ï¼š
1. **è·å–æäº¤åˆ—è¡¨** (`get_recent_commits()`)
   - æ‰§è¡Œ `git log -N --pretty=format:%H|%s`
   - è§£ææ¯ä¸ªæäº¤çš„ hash å’Œ message
   - è·å–æ¯ä¸ªæäº¤çš„ diff (`git show --stat`)

2. **ç”Ÿæˆæ–°æ¶ˆæ¯**
   - å¯¹æ¯ä¸ªæäº¤è°ƒç”¨ `call_local_model()`
   - ä½¿ç”¨ `build_rewrite_prompt()` æ„å»ºé‡å†™ Prompt

3. **æ‰§è¡Œé‡å†™** (`rewrite_with_rebase()`)
   - åˆ›å»ºå¤‡ä»½åˆ†æ”¯
   - ä½¿ç”¨ `git filter-branch` æ‰¹é‡æ›¿æ¢ commit message
   - ç”Ÿæˆ shell è„šæœ¬ï¼Œæ ¹æ® commit hash è¿”å›å¯¹åº”çš„æ–° message

**Git Filter-Branch åŸç†**ï¼š
```bash
# ç”Ÿæˆçš„è„šæœ¬ç¤ºä¾‹
case "$GIT_COMMIT" in
    abc123)
        echo "feat: æ–°çš„ commit message"
        ;;
    def456)
        echo "fix: ä¿®å¤æŸä¸ªé—®é¢˜"
        ;;
    *)
        cat  # ä¿æŒåŸ message
        ;;
esac
```

---

### 2. candle_model.rs æ ¸å¿ƒå‡½æ•°

#### `CandleModel::load_from_path()` - æ¨¡å‹åŠ è½½

**åŠŸèƒ½**ï¼šä»æœ¬åœ°æ–‡ä»¶ç³»ç»ŸåŠ è½½ Qwen2.5-Coder æ¨¡å‹

**åŠ è½½æ­¥éª¤è¯¦è§£**ï¼š

##### æ­¥éª¤ 1: éªŒè¯æ¨¡å‹æ–‡ä»¶

```rust
if !model_path.exists() {
    anyhow::bail!("æ¨¡å‹æ–‡ä»¶ä¸å­˜åœ¨: {}", model_path.display());
}
```

##### æ­¥éª¤ 2: åŠ è½½ config.json

**æ–‡ä»¶ä½ç½®**ï¼š`<model_dir>/config.json`

**æ–‡ä»¶å†…å®¹ç¤ºä¾‹**ï¼š
```json
{
  "vocab_size": 151936,
  "hidden_size": 896,
  "intermediate_size": 4864,
  "num_hidden_layers": 24,
  "num_attention_heads": 14,
  "max_position_embeddings": 32768,
  "model_type": "qwen2",
  ...
}
```

**å­—æ®µå«ä¹‰**ï¼š
- `vocab_size`: è¯æ±‡è¡¨å¤§å°ï¼ˆæ¨¡å‹èƒ½è¯†åˆ«çš„ token æ€»æ•°ï¼‰
- `hidden_size`: éšè—å±‚ç»´åº¦ï¼ˆæ¯å±‚ç¥ç»ç½‘ç»œçš„å®½åº¦ï¼‰
- `num_hidden_layers`: Transformer å±‚æ•°ï¼ˆæ¨¡å‹æ·±åº¦ï¼‰
- `num_attention_heads`: æ³¨æ„åŠ›å¤´æ•°ï¼ˆå¹¶è¡Œæ³¨æ„åŠ›æœºåˆ¶æ•°é‡ï¼‰
- `max_position_embeddings`: æœ€å¤§åºåˆ—é•¿åº¦ï¼ˆæ¨¡å‹èƒ½å¤„ç†çš„æœ€å¤§ token æ•°ï¼‰

**åŠ è½½ä»£ç **ï¼š
```rust
let config_path = model_dir.join("config.json");
let config_content = fs::read_to_string(&config_path)?;
let config: QwenConfig = serde_json::from_str(&config_content)?;
```

##### æ­¥éª¤ 3: åŠ è½½ Tokenizer

**æ–‡ä»¶ä½ç½®**ï¼š`<model_dir>/tokenizer.json`

**Tokenizer ä½œç”¨**ï¼š
- **ç¼–ç  (Encode)**ï¼šå°†æ–‡æœ¬è½¬æ¢ä¸º token ID åºåˆ—
- **è§£ç  (Decode)**ï¼šå°† token ID åºåˆ—è½¬æ¢å›æ–‡æœ¬

**ç¤ºä¾‹**ï¼š
```
è¾“å…¥æ–‡æœ¬: "feat: æ·»åŠ æ–°åŠŸèƒ½"
â†“ Tokenization
Token IDs: [1234, 5678, 9012, 3456, 7890]
â†“ æ¨¡å‹æ¨ç†
è¾“å‡º Token IDs: [1111, 2222, 3333]
â†“ Decode
è¾“å‡ºæ–‡æœ¬: "æ·»åŠ äº†ç”¨æˆ·ç™»å½•åŠŸèƒ½"
```

**åŠ è½½ä»£ç **ï¼š
```rust
let tokenizer_path = model_dir.join("tokenizer.json");
let tokenizer = Tokenizer::from_file(tokenizer_path)?;
```

##### æ­¥éª¤ 4: åŠ è½½æ¨¡å‹æƒé‡

**æ–‡ä»¶ä½ç½®**ï¼š`<model_dir>/model.safetensors` æˆ– `model-*.safetensors` (åˆ†ç‰‡)

**Safetensors æ ¼å¼**ï¼š
- **å®‰å…¨**ï¼šé˜²æ­¢æ¶æ„ä»£ç æ‰§è¡Œï¼ˆç›¸æ¯” Pickle æ ¼å¼ï¼‰
- **é«˜æ•ˆ**ï¼šå¿«é€ŸåŠ è½½ï¼Œæ”¯æŒå†…å­˜æ˜ å°„
- **è·¨è¯­è¨€**ï¼šRustã€Pythonã€JavaScript éƒ½æ”¯æŒ

**æ–‡ä»¶ç»“æ„**ï¼š
```
model.safetensors
â”œâ”€ metadata (å…ƒæ•°æ®)
â”‚  â””â”€ æ¨¡å‹ä¿¡æ¯ã€ç‰ˆæœ¬ç­‰
â””â”€ tensors (å¼ é‡æ•°æ®)
   â”œâ”€ layer.0.attention.weight: [896, 896] float32
   â”œâ”€ layer.0.attention.bias: [896] float32
   â”œâ”€ layer.1.attention.weight: [896, 896] float32
   â””â”€ ... (æ‰€æœ‰å±‚çš„æƒé‡)
```

**åŠ è½½ä»£ç **ï¼š
```rust
// æŸ¥æ‰¾æ‰€æœ‰ model*.safetensors æ–‡ä»¶ï¼ˆæ”¯æŒåˆ†ç‰‡ï¼‰
let safetensors_files = find_safetensors_files(model_dir)?;

// ä½¿ç”¨å†…å­˜æ˜ å°„åŠ è½½ï¼ˆä¸ç«‹å³åŠ è½½åˆ°å†…å­˜ï¼‰
let vb = unsafe {
    VarBuilder::from_mmaped_safetensors(
        &safetensors_files,
        DType::F32,  // æ•°æ®ç±»å‹ï¼š32ä½æµ®ç‚¹æ•°
        &device      // è®¾å¤‡ï¼šCPU
    )?
};
```

**å†…å­˜æ˜ å°„ (Memory Mapping)**ï¼š
- **ä¼˜åŠ¿**ï¼šä¸ç«‹å³åŠ è½½æ•´ä¸ªæ–‡ä»¶åˆ°å†…å­˜ï¼ŒæŒ‰éœ€è¯»å–
- **åŸç†**ï¼šæ“ä½œç³»ç»Ÿå°†æ–‡ä»¶æ˜ å°„åˆ°è™šæ‹Ÿå†…å­˜ï¼Œè®¿é—®æ—¶æ‰åŠ è½½ç‰©ç†å†…å­˜
- **é€‚ç”¨**ï¼šå¤§æ–‡ä»¶ï¼ˆå¦‚ 988MB çš„æ¨¡å‹æ–‡ä»¶ï¼‰

##### æ­¥éª¤ 5: åˆ›å»ºæ¨¡å‹å®ä¾‹

```rust
let model = QwenModel::new(&config, vb)?;
```

**QwenModel ç»“æ„**ï¼š
- åŸºäº Transformer æ¶æ„
- åŒ…å«å¤šä¸ª Transformer å±‚ï¼ˆ`num_hidden_layers`ï¼‰
- æ¯å±‚åŒ…å«ï¼šè‡ªæ³¨æ„åŠ›æœºåˆ¶ + å‰é¦ˆç¥ç»ç½‘ç»œ

#### `CandleModel::generate()` - æ–‡æœ¬ç”Ÿæˆ

**åŠŸèƒ½**ï¼šæ ¹æ®è¾“å…¥ Prompt ç”Ÿæˆæ–‡æœ¬

**æ‰§è¡Œæµç¨‹è¯¦è§£**ï¼š

##### æ­¥éª¤ 1: æ ¼å¼åŒ– Prompt

**Qwen2.5-Coder æŒ‡ä»¤æ ¼å¼**ï¼š
```
<|im_start|>system
{system_message}<|im_end|>
<|im_start|>user
{user_message}<|im_end|>
<|im_start|>assistant
```

**ç¤ºä¾‹**ï¼š
```
<|im_start|>system
You are a helpful assistant that generates commit messages based on code changes. Follow Conventional Commits format.<|im_end|>
<|im_start|>user
æ ¹æ®ä»¥ä¸‹ Git å˜æ›´ï¼Œç”Ÿæˆä¸€ä¸ªç¬¦åˆ Conventional Commits è§„èŒƒçš„ commit messageã€‚

å˜æ›´å†…å®¹ï¼š
- æ–°å¢ src/commands/gcm_ai.rs (åç«¯)
<|im_end|>
<|im_start|>assistant
```

**ä»£ç **ï¼š
```rust
let formatted_prompt = format!(
    "<|im_start|>system\nYou are a helpful assistant...<|im_end|>\n\
     <|im_start|>user\n{}\n<|im_end|>\n\
     <|im_start|>assistant\n",
    prompt
);
```

##### æ­¥éª¤ 2: Tokenizationï¼ˆç¼–ç ï¼‰

**è¿‡ç¨‹**ï¼š
```
æ–‡æœ¬ â†’ Tokenizer â†’ Token IDs
```

**ä»£ç **ï¼š
```rust
let encoding = self.tokenizer.encode(formatted_prompt.as_str(), true)?;
let input_ids: Vec<u32> = encoding.get_ids()
    .iter()
    .map(|&x| x as u32)
    .collect();
```

**ç¤ºä¾‹**ï¼š
```
è¾“å…¥: "feat: æ·»åŠ æ–°åŠŸèƒ½"
è¾“å‡º: [1234, 5678, 9012, 3456, 7890]
```

##### æ­¥éª¤ 3: è½¬æ¢ä¸ºå¼ é‡ (Tensor)

**å¼ é‡ (Tensor)**ï¼š
- **å®šä¹‰**ï¼šå¤šç»´æ•°ç»„ï¼Œç”¨äºå­˜å‚¨ç¥ç»ç½‘ç»œçš„æ•°æ®
- **å½¢çŠ¶**ï¼š`[batch_size, sequence_length]`
  - `batch_size = 1`ï¼ˆä¸€æ¬¡å¤„ç†ä¸€ä¸ªåºåˆ—ï¼‰
  - `sequence_length = input_ids.len()`ï¼ˆè¾“å…¥ token æ•°é‡ï¼‰

**ä»£ç **ï¼š
```rust
let input_tensor = Tensor::new(input_ids.as_slice(), &device)?
    .unsqueeze(0)?; // æ·»åŠ  batch ç»´åº¦: [1, seq_len]
```

**ç¤ºä¾‹**ï¼š
```
input_ids: [1234, 5678, 9012]
â†“
input_tensor: [[1234, 5678, 9012]]  // å½¢çŠ¶: [1, 3]
```

##### æ­¥éª¤ 4: æ¨¡å‹è®¡ç®—ï¼ˆè¿™å°±æ˜¯"æ¨ç†"ï¼‰

**ä»€ä¹ˆæ˜¯"æ¨ç†"ï¼Ÿ**
- **æ¨ç† = è¾“å…¥ â†’ è¾“å‡º**ï¼šè¿™å°±æ˜¯ä½ æƒ³è¦çš„"ç›´æ¥è¾“å…¥ï¼Œæ¨¡å‹ç»™æˆ‘è¾“å‡º"çš„è¿‡ç¨‹
- **ä¸ºä»€ä¹ˆå«"æ¨ç†"**ï¼šè¿™æ˜¯æœºå™¨å­¦ä¹ çš„æœ¯è¯­ï¼Œè¡¨ç¤ºæ¨¡å‹æ ¹æ®è¾“å…¥"æ¨ç†"å‡ºè¾“å‡º
- **å®é™…ä¸Šå°±æ˜¯**ï¼šæ¨¡å‹å¤„ç†ä½ çš„è¾“å…¥ï¼Œç„¶åç»™ä½ è¾“å‡ºç»“æœ

**Transformer è®¡ç®—è¿‡ç¨‹**ï¼ˆè¿™å°±æ˜¯"æ¨ç†"çš„å†…éƒ¨å®ç°ï¼‰ï¼š

```
è¾“å…¥å¼ é‡ [1, seq_len]
    â†“
åµŒå…¥å±‚ (Embedding)
    â†“
ä½ç½®ç¼–ç  (Positional Encoding)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Transformer Layer 1     â”‚
â”‚ â”œâ”€ è‡ªæ³¨æ„åŠ› (Self-Attn)  â”‚
â”‚ â””â”€ å‰é¦ˆç½‘ç»œ (FFN)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Transformer Layer 2     â”‚
â”‚ ...                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
    ...
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Transformer Layer 24   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
è¾“å‡ºå±‚ (Output Layer)
    â†“
Logits [1, seq_len, vocab_size]
```

**ä»£ç **ï¼š
```rust
// è¿™å°±æ˜¯"æ¨ç†"ï¼šè¾“å…¥ promptï¼Œæ¨¡å‹è®¡ç®—åç»™ä½ è¾“å‡º
let logits = self.model.forward(&input_tensor, 0, None)?;
```

**ä¸ºä»€ä¹ˆéœ€è¦"è®¡ç®—"ï¼Ÿ**
- æ¨¡å‹ä¸æ˜¯å­—å…¸ï¼Œä¸èƒ½ç›´æ¥æŸ¥è¡¨
- æ¨¡å‹æ˜¯**ç¥ç»ç½‘ç»œ**ï¼Œéœ€è¦ç»è¿‡å¤šå±‚è®¡ç®—æ‰èƒ½å¾—åˆ°ç»“æœ
- å°±åƒè®¡ç®—å™¨ï¼šä½ è¾“å…¥ `2 + 3`ï¼Œå®ƒéœ€è¦è®¡ç®—æ‰èƒ½ç»™ä½  `5`
- æ¨¡å‹ä¹Ÿæ˜¯ï¼šä½ è¾“å…¥ promptï¼Œå®ƒéœ€è¦ç»è¿‡ 24 å±‚ç¥ç»ç½‘ç»œè®¡ç®—æ‰èƒ½ç»™ä½ è¾“å‡º

**å‚æ•°è¯´æ˜**ï¼š
- `&input_tensor`: ä½ çš„è¾“å…¥ï¼ˆå·²ç»è½¬æ¢æˆæ•°å­—ï¼‰
- `0`: åºåˆ—ä½ç½®ï¼ˆæŠ€æœ¯ç»†èŠ‚ï¼Œå½“å‰ä¸º 0ï¼‰
- `None`: ç¼“å­˜ï¼ˆæŠ€æœ¯ç»†èŠ‚ï¼Œå½“å‰æœªä½¿ç”¨ï¼‰

**è¾“å‡ºç»“æœï¼ˆLogitsï¼‰**ï¼š
- **å«ä¹‰**ï¼šæ¨¡å‹è®¡ç®—å‡ºçš„"æ¯ä¸ªå¯èƒ½å•è¯çš„å¾—åˆ†"
- **å½¢çŠ¶**ï¼š`[1, åºåˆ—é•¿åº¦, 151936ä¸ªå¯èƒ½çš„å•è¯]`
- **ç¤ºä¾‹**ï¼šå¯¹äºä½ çš„ prompt çš„æœ€åä¸€ä¸ªä½ç½®ï¼Œæ¨¡å‹è®¡ç®—äº† 151936 ä¸ªå¯èƒ½å•è¯çš„å¾—åˆ†
  - `"feat"` å¾—åˆ†ï¼š5.7
  - `"fix"` å¾—åˆ†ï¼š3.2
  - `"hello"` å¾—åˆ†ï¼š-2.1
  - ...
  - æ¨¡å‹é€‰æ‹©å¾—åˆ†æœ€é«˜çš„ï¼ˆæ¯”å¦‚ `"feat"`ï¼‰ä½œä¸ºè¾“å‡º

##### æ­¥éª¤ 5: é‡‡æ ·ä¸‹ä¸€ä¸ª Token

**å½“å‰å®ç°ï¼ˆç®€åŒ–ç‰ˆï¼‰**ï¼š
```rust
// è·å–æœ€åä¸€ä¸ªä½ç½®çš„ logits
let last_logits = logits.narrow(1, last_idx, 1)?.squeeze(1)?;
// å½¢çŠ¶: [1, vocab_size]

// ä½¿ç”¨ argmax é€‰æ‹©åˆ†æ•°æœ€é«˜çš„ token
let next_token_id = last_logits.argmax(1)?.to_vec1::<u32>()?[0];
```

**Argmax é‡‡æ ·**ï¼š
- **åŸç†**ï¼šé€‰æ‹©æ¦‚ç‡æœ€é«˜çš„ token
- **ä¼˜ç‚¹**ï¼šç®€å•ã€ç¡®å®šæ€§å¼º
- **ç¼ºç‚¹**ï¼šå¯èƒ½ç”Ÿæˆé‡å¤ã€ç¼ºä¹åˆ›é€ æ€§

**æ›´é«˜çº§çš„é‡‡æ ·ç­–ç•¥**ï¼ˆæœªæ¥å¯æ”¹è¿›ï¼‰ï¼š
- **Temperature Sampling**ï¼šè°ƒæ•´æ¦‚ç‡åˆ†å¸ƒçš„å¹³æ»‘åº¦
- **Top-K Sampling**ï¼šåªä»æ¦‚ç‡æœ€é«˜çš„ K ä¸ª token ä¸­é€‰æ‹©
- **Top-P (Nucleus) Sampling**ï¼šä»ç´¯ç§¯æ¦‚ç‡è¾¾åˆ° P çš„ token é›†åˆä¸­é€‰æ‹©

##### æ­¥éª¤ 6: è§£ç è¾“å‡º

**å½“å‰å®ç°ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰**ï¼š
```rust
// ç”±äºå®Œæ•´çš„å¢é‡ç”Ÿæˆéœ€è¦ KV cacheï¼Œå½“å‰è¿”å›å›ºå®šæ¨¡æ¿
let output_text = "feat: æ›´æ–°ä»£ç \n\n- ä¿®å¤æ¨¡å‹æ¨ç†é—®é¢˜\n- å®Œå–„é”™è¯¯å¤„ç†æœºåˆ¶";
```

**å®Œæ•´å®ç°ï¼ˆéœ€è¦ KV Cacheï¼‰**ï¼š
```rust
// 1. å°†æ–° token æ·»åŠ åˆ°åºåˆ—
all_tokens.push(next_token_id);

// 2. è§£ç ç”Ÿæˆçš„ tokens
let output_text = self.tokenizer.decode(&generated_tokens, true)?;

// 3. æ¸…ç†è¾“å‡ºï¼ˆç§»é™¤æ ¼å¼æ ‡è®°ï¼‰
let cleaned_output = output_text
    .trim()
    .replace("<|im_end|>", "")
    .replace("<|im_start|>", "");
```

---

## æ¨¡å‹æ–‡ä»¶ç»“æ„

### ç›®å½•ç»“æ„

```
~/.cyber-zen/models/
â””â”€â”€ default_qwen2-5/          # æ¨¡å‹ç›®å½•ï¼ˆä»¥ default_ å¼€å¤´ï¼‰
    â”œâ”€â”€ model.safetensors     # æ¨¡å‹æƒé‡æ–‡ä»¶ï¼ˆ988MBï¼‰
    â”œâ”€â”€ config.json           # æ¨¡å‹é…ç½®æ–‡ä»¶
    â”œâ”€â”€ tokenizer.json        # Tokenizer æ–‡ä»¶
    â””â”€â”€ tokenizer_config.json # Tokenizer é…ç½®ï¼ˆå¯é€‰ï¼‰
```

### æ–‡ä»¶è¯¦è§£

#### 1. model.safetensors

**æ–‡ä»¶ç±»å‹**ï¼šäºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆSafetensors æ ¼å¼ï¼‰

**å¤§å°**ï¼šçº¦ 988MBï¼ˆQwen2.5-Coder-0.5B-Instructï¼‰

**å†…å®¹**ï¼š
- **æ¨¡å‹æƒé‡**ï¼šæ‰€æœ‰ç¥ç»ç½‘ç»œå±‚çš„å‚æ•°
  - åµŒå…¥å±‚æƒé‡
  - Transformer å±‚æƒé‡ï¼ˆ24 å±‚ï¼‰
    - æ³¨æ„åŠ›æœºåˆ¶æƒé‡ï¼ˆQuery, Key, Value, Outputï¼‰
    - å‰é¦ˆç½‘ç»œæƒé‡
  - è¾“å‡ºå±‚æƒé‡

**æ•°æ®ç»“æ„**ï¼š
```
{
  "embeddings.weight": Tensor[151936, 896],      // è¯åµŒå…¥
  "layers.0.attention.wq.weight": Tensor[896, 896],  // ç¬¬1å±‚ Query
  "layers.0.attention.wk.weight": Tensor[896, 896],  // ç¬¬1å±‚ Key
  "layers.0.attention.wv.weight": Tensor[896, 896],  // ç¬¬1å±‚ Value
  "layers.0.attention.wo.weight": Tensor[896, 896],  // ç¬¬1å±‚ Output
  "layers.0.feed_forward.w1.weight": Tensor[4864, 896],  // ç¬¬1å±‚ FFN
  "layers.0.feed_forward.w2.weight": Tensor[896, 4864],
  "layers.0.feed_forward.w3.weight": Tensor[4864, 896],
  ...
  "layers.23.attention.wq.weight": Tensor[896, 896],  // ç¬¬24å±‚
  ...
  "lm_head.weight": Tensor[151936, 896]  // è¾“å‡ºå±‚
}
```

**åŠ è½½æ–¹å¼**ï¼š
- ä½¿ç”¨å†…å­˜æ˜ å°„ï¼ˆMemory Mappingï¼‰
- æŒ‰éœ€åŠ è½½ï¼Œä¸ä¸€æ¬¡æ€§è¯»å…¥å†…å­˜

#### 2. config.json

**æ–‡ä»¶ç±»å‹**ï¼šJSON æ–‡æœ¬æ–‡ä»¶

**å¤§å°**ï¼šçº¦ 659 bytes

**å†…å®¹ç¤ºä¾‹**ï¼š
```json
{
  "architectures": ["Qwen2ForCausalLM"],
  "attention_dropout": 0.0,
  "bos_token_id": 151643,
  "eos_token_id": 151643,
  "hidden_act": "silu",
  "hidden_size": 896,
  "intermediate_size": 4864,
  "max_position_embeddings": 32768,
  "model_type": "qwen2",
  "num_attention_heads": 14,
  "num_hidden_layers": 24,
  "num_key_value_heads": 2,
  "rms_norm_eps": 1e-6,
  "rope_theta": 1000000.0,
  "tie_word_embeddings": false,
  "torch_dtype": "float32",
  "transformers_version": "4.37.0",
  "use_cache": true,
  "vocab_size": 151936
}
```

**å…³é”®å­—æ®µè¯´æ˜**ï¼š

| å­—æ®µ | å€¼ | å«ä¹‰ |
|------|-----|------|
| `vocab_size` | 151936 | è¯æ±‡è¡¨å¤§å°ï¼Œæ¨¡å‹èƒ½è¯†åˆ« 151936 ç§ä¸åŒçš„ token |
| `hidden_size` | 896 | éšè—å±‚ç»´åº¦ï¼Œæ¯å±‚ç¥ç»ç½‘ç»œçš„å®½åº¦ä¸º 896 |
| `num_hidden_layers` | 24 | Transformer å±‚æ•°ï¼Œæ¨¡å‹æœ‰ 24 å±‚ |
| `num_attention_heads` | 14 | æ³¨æ„åŠ›å¤´æ•°ï¼Œæ¯å±‚æœ‰ 14 ä¸ªå¹¶è¡Œæ³¨æ„åŠ›æœºåˆ¶ |
| `intermediate_size` | 4864 | å‰é¦ˆç½‘ç»œä¸­é—´å±‚å¤§å° |
| `max_position_embeddings` | 32768 | æœ€å¤§åºåˆ—é•¿åº¦ï¼Œæ¨¡å‹èƒ½å¤„ç†æœ€å¤š 32768 ä¸ª token |
| `eos_token_id` | 151643 | ç»“æŸç¬¦ token IDï¼Œè¡¨ç¤ºç”Ÿæˆç»“æŸ |
| `model_type` | "qwen2" | æ¨¡å‹æ¶æ„ç±»å‹ |

**ç”¨é€”**ï¼š
- åˆå§‹åŒ–æ¨¡å‹ç»“æ„
- éªŒè¯æ¨¡å‹æ–‡ä»¶å®Œæ•´æ€§
- é…ç½®æ¨ç†å‚æ•°

#### 3. tokenizer.json

**æ–‡ä»¶ç±»å‹**ï¼šJSON æ–‡æœ¬æ–‡ä»¶

**å¤§å°**ï¼šçº¦å‡  MB

**å†…å®¹**ï¼š
- **è¯æ±‡è¡¨**ï¼štoken ID åˆ°æ–‡æœ¬çš„æ˜ å°„
- **ç‰¹æ®Š token**ï¼š`<|im_start|>`, `<|im_end|>`, `<|endoftext|>` ç­‰
- **ç¼–ç è§„åˆ™**ï¼šBPE (Byte Pair Encoding) ç®—æ³•é…ç½®

**ç¤ºä¾‹ç»“æ„**ï¼š
```json
{
  "version": "1.0",
  "truncation": null,
  "padding": null,
  "added_tokens": [
    {"id": 151643, "content": "<|im_end|>", "special": true},
    {"id": 151644, "content": "<|im_start|>", "special": true},
    ...
  ],
  "normalizer": {...},
  "pre_tokenizer": {...},
  "post_processor": {...},
  "decoder": {...},
  "model": {
    "type": "BPE",
    "dropout": null,
    "unk_token": null,
    "continuing_subword_prefix": null,
    "end_of_word_suffix": null,
    "fuse_unk": false,
    "byte_fallback": false,
    "vocab": {
      "!": 0,
      "\"": 1,
      "#": 2,
      ...
      "feat": 1234,
      ":": 5678,
      ...
    },
    "merges": [...]
  }
}
```

**BPE (Byte Pair Encoding) åŸç†**ï¼š
1. **åˆå§‹åŒ–**ï¼šå°†æ–‡æœ¬æ‹†åˆ†ä¸ºå­—ç¬¦
2. **è¿­ä»£åˆå¹¶**ï¼šæ‰¾åˆ°å‡ºç°é¢‘ç‡æœ€é«˜çš„å­—ç¬¦å¯¹ï¼Œåˆå¹¶ä¸ºæ–° token
3. **æ„å»ºè¯æ±‡è¡¨**ï¼šé‡å¤ç›´åˆ°è¾¾åˆ°ç›®æ ‡è¯æ±‡è¡¨å¤§å°

**ç¤ºä¾‹**ï¼š
```
åŸå§‹æ–‡æœ¬: "feat: æ·»åŠ æ–°åŠŸèƒ½"
â†“ BPE ç¼–ç 
Tokens: ["feat", ":", "æ·»åŠ ", "æ–°", "åŠŸèƒ½"]
â†“ Token ID æ˜ å°„
Token IDs: [1234, 5678, 9012, 3456, 7890]
```

#### 4. tokenizer_config.jsonï¼ˆå¯é€‰ï¼‰

**æ–‡ä»¶ç±»å‹**ï¼šJSON æ–‡æœ¬æ–‡ä»¶

**å†…å®¹**ï¼š
- Tokenizer çš„é¢å¤–é…ç½®
- ç‰¹æ®Š token çš„å®šä¹‰
- ç¼–ç å‚æ•°

**ç¤ºä¾‹**ï¼š
```json
{
  "tokenizer_class": "PreTrainedTokenizerFast",
  "auto_map": {...},
  "bos_token": "<|endoftext|>",
  "eos_token": "<|im_end|>",
  "unk_token": "<|endoftext|>",
  "pad_token": null,
  "chat_template": "..."
}
```

---

## å·¥ä½œæµç¨‹

### åœºæ™¯ 1: ç”Ÿæˆæ–°æäº¤çš„ Commit Message

```
ç”¨æˆ·æ‰§è¡Œ: cyber-zen gcm-ai
    â†“
1. æŸ¥æ‰¾æ¨¡å‹æ–‡ä»¶
   â””â”€ ~/.cyber-zen/models/default_qwen2-5/model.safetensors
    â†“
2. éªŒè¯ Git ä»“åº“
   â””â”€ git rev-parse --git-dir
    â†“
3. åˆ†æ Git å˜æ›´
   â””â”€ git status --porcelain
   â””â”€ è§£æ: "M src/commands/gcm_ai.rs"
    â†“
4. æ˜¾ç¤ºå˜æ›´ä¿¡æ¯
   â””â”€ ğŸ”§ ä¿®æ”¹: src/commands/gcm_ai.rs
    â†“
5. æ„å»º Prompt
   â””â”€ "æ ¹æ®ä»¥ä¸‹ Git å˜æ›´ï¼Œç”Ÿæˆä¸€ä¸ªç¬¦åˆ Conventional Commits è§„èŒƒçš„ commit messageã€‚
       å˜æ›´å†…å®¹ï¼š
       - ä¿®æ”¹ src/commands/gcm_ai.rs (åç«¯)"
    â†“
6. åŠ è½½æ¨¡å‹
   â”œâ”€ è¯»å– config.json
   â”œâ”€ åŠ è½½ tokenizer.json
   â””â”€ å†…å­˜æ˜ å°„ model.safetensors
    â†“
7. Tokenization
   â””â”€ Prompt â†’ Token IDs: [1234, 5678, ...]
    â†“
8. æ¨¡å‹æ¨ç†
   â””â”€ Token IDs â†’ Logits â†’ é‡‡æ · â†’ Token ID
    â†“
9. ç”Ÿæˆæ–‡æœ¬ï¼ˆå½“å‰ä¸ºå›ºå®šæ¨¡æ¿ï¼‰
   â””â”€ "feat: æ›´æ–°ä»£ç \n\n- ä¿®å¤æ¨¡å‹æ¨ç†é—®é¢˜"
    â†“
10. ç”¨æˆ·ç¡®è®¤
    â””â”€ "æ˜¯å¦ä½¿ç”¨æ­¤æ¶ˆæ¯? [Y/n]"
    â†“
11. æ‰§è¡Œ Git æ“ä½œ
    â”œâ”€ git add .
    â”œâ”€ git commit -m "feat: æ›´æ–°ä»£ç ..."
    â””â”€ git push
```

### åœºæ™¯ 2: é‡å†™å†å²æäº¤

```
ç”¨æˆ·æ‰§è¡Œ: cyber-zen gcm-ai --rewrite --max-commits 5
    â†“
1. è·å–æœ€è¿‘ 5 ä¸ªæäº¤
   â””â”€ git log -5 --pretty=format:%H|%s
    â†“
2. å¯¹æ¯ä¸ªæäº¤ï¼š
   â”œâ”€ è·å–åŸå§‹ message
   â”œâ”€ è·å– diff (git show --stat)
   â”œâ”€ æ„å»ºé‡å†™ Prompt
   â”œâ”€ è°ƒç”¨ AI ç”Ÿæˆæ–° message
   â””â”€ ä¿å­˜ (hash, new_message) å¯¹
    â†“
3. åˆ›å»ºå¤‡ä»½åˆ†æ”¯
   â””â”€ git branch backup-before-rewrite-20240102-120000
    â†“
4. ç”Ÿæˆ filter-branch è„šæœ¬
   â””â”€ case "$GIT_COMMIT" in
      abc123) echo "feat: æ–°æ¶ˆæ¯" ;;
      def456) echo "fix: æ–°æ¶ˆæ¯" ;;
      *) cat ;;
      esac
    â†“
5. æ‰§è¡Œ git filter-branch
   â””â”€ git filter-branch -f --msg-filter "bash script.sh" abc123^..def456
    â†“
6. å®Œæˆ
   â””â”€ æç¤ºç”¨æˆ·ä½¿ç”¨ git push --force-with-lease æ›´æ–°è¿œç¨‹
```

---

## æŠ€æœ¯åŸç†

### 0. ä¸ºä»€ä¹ˆéœ€è¦"æ¨ç†"ï¼Ÿâ€”â€” ç”¨é€šä¿—çš„è¯è§£é‡Š

**ä½ çš„æœŸæœ›**ï¼š
```
è¾“å…¥: "æ ¹æ®ä»£ç å˜æ›´ç”Ÿæˆ commit message"
è¾“å‡º: "feat: æ·»åŠ æ–°åŠŸèƒ½"
```

**å®é™…æƒ…å†µ**ï¼š
```
è¾“å…¥: "æ ¹æ®ä»£ç å˜æ›´ç”Ÿæˆ commit message"
  â†“
æ¨¡å‹éœ€è¦è®¡ç®—ï¼ˆè¿™å°±æ˜¯"æ¨ç†"ï¼‰ï¼š
  1. æŠŠæ–‡å­—è½¬æ¢æˆæ•°å­—
  2. ç»è¿‡ 24 å±‚ç¥ç»ç½‘ç»œè®¡ç®—
  3. æ¯å±‚éƒ½è¦åšæ•°å­¦è¿ç®—ï¼ˆçŸ©é˜µä¹˜æ³•ã€æ³¨æ„åŠ›è®¡ç®—ç­‰ï¼‰
  4. æœ€åå¾—åˆ°æ¯ä¸ªå¯èƒ½å•è¯çš„å¾—åˆ†
  5. é€‰æ‹©å¾—åˆ†æœ€é«˜çš„å•è¯
  â†“
è¾“å‡º: "feat: æ·»åŠ æ–°åŠŸèƒ½"
```

**ä¸ºä»€ä¹ˆä¸èƒ½"ç›´æ¥"è¾“å…¥è¾“å‡ºï¼Ÿ**
- æ¨¡å‹ä¸æ˜¯å­—å…¸ï¼Œä¸èƒ½ç›´æ¥æŸ¥è¡¨
- æ¨¡å‹æ˜¯**ç¥ç»ç½‘ç»œ**ï¼Œå°±åƒäººçš„å¤§è„‘ï¼š
  - ä½ é—®"2+3ç­‰äºå‡ ï¼Ÿ"
  - å¤§è„‘éœ€è¦"è®¡ç®—"æ‰èƒ½å›ç­”"5"
  - æ¨¡å‹ä¹Ÿéœ€è¦"è®¡ç®—"æ‰èƒ½å›ç­”ä½ çš„é—®é¢˜

**"æ¨ç†"å°±æ˜¯"è®¡ç®—"çš„æ„æ€**ï¼š
- æœºå™¨å­¦ä¹ æœ¯è¯­å«"æ¨ç†"ï¼ˆInferenceï¼‰
- å®é™…ä¸Šå°±æ˜¯"è®¡ç®—"ï¼ˆComputationï¼‰
- å°±æ˜¯"è¾“å…¥ â†’ è®¡ç®— â†’ è¾“å‡º"çš„è¿‡ç¨‹

**ç±»æ¯”**ï¼š
- **è®¡ç®—å™¨**ï¼šè¾“å…¥ `2+3` â†’ è®¡ç®— â†’ è¾“å‡º `5`
- **æ¨¡å‹**ï¼šè¾“å…¥ `prompt` â†’ æ¨ç†ï¼ˆè®¡ç®—ï¼‰â†’ è¾“å‡º `commit message`

### 1. Transformer æ¶æ„

**Transformer æ˜¯ä»€ä¹ˆ**ï¼š
- ä¸€ç§æ·±åº¦å­¦ä¹ æ¶æ„ï¼Œç”¨äºå¤„ç†åºåˆ—æ•°æ®ï¼ˆæ–‡æœ¬ã€ä»£ç ç­‰ï¼‰
- 2017 å¹´ç”± Google æå‡ºï¼Œç°å·²æˆä¸ºå¤§è¯­è¨€æ¨¡å‹çš„åŸºç¡€

**æ ¸å¿ƒç»„ä»¶**ï¼š

#### è‡ªæ³¨æ„åŠ›æœºåˆ¶ (Self-Attention)

**ä½œç”¨**ï¼šè®©æ¨¡å‹ç†è§£æ–‡æœ¬ä¸­ä¸åŒä½ç½®ä¹‹é—´çš„å…³ç³»

**åŸç†**ï¼š
```
è¾“å…¥åºåˆ—: ["feat", ":", "æ·»åŠ ", "æ–°", "åŠŸèƒ½"]
         â†“
è®¡ç®—æ¯ä¸ª token ä¸å…¶ä»–æ‰€æœ‰ token çš„å…³è”åº¦
         â†“
"æ·»åŠ " å…³æ³¨ "feat" (ç±»å‹)
"åŠŸèƒ½" å…³æ³¨ "æ·»åŠ " (åŠ¨ä½œ)
         â†“
è¾“å‡º: æ¯ä¸ª token çš„ä¸Šä¸‹æ–‡æ„ŸçŸ¥è¡¨ç¤º
```

**æ•°å­¦å…¬å¼**ï¼š
```
Attention(Q, K, V) = softmax(QK^T / âˆšd_k) V
```

- `Q` (Query): æŸ¥è¯¢å‘é‡
- `K` (Key): é”®å‘é‡
- `V` (Value): å€¼å‘é‡
- `d_k`: ç»´åº¦ç¼©æ”¾å› å­

#### å¤šå¤´æ³¨æ„åŠ› (Multi-Head Attention)

**ä½œç”¨**ï¼šå¹¶è¡Œè®¡ç®—å¤šä¸ªæ³¨æ„åŠ›ï¼Œæ•è·ä¸åŒç±»å‹çš„å…³ç³»

**Qwen2.5-Coder é…ç½®**ï¼š
- 14 ä¸ªæ³¨æ„åŠ›å¤´ (`num_attention_heads = 14`)
- æ¯ä¸ªå¤´å…³æ³¨ä¸åŒçš„è¯­ä¹‰å…³ç³»

#### å‰é¦ˆç¥ç»ç½‘ç»œ (Feed-Forward Network)

**ä½œç”¨**ï¼šå¯¹æ¯ä¸ªä½ç½®è¿›è¡Œéçº¿æ€§å˜æ¢

**ç»“æ„**ï¼š
```
è¾“å…¥ â†’ Linear(896 â†’ 4864) â†’ SiLU æ¿€æ´» â†’ Linear(4864 â†’ 896) â†’ è¾“å‡º
```

#### å±‚å½’ä¸€åŒ– (Layer Normalization)

**ä½œç”¨**ï¼šç¨³å®šè®­ç»ƒï¼ŒåŠ é€Ÿæ”¶æ•›

**ä½ç½®**ï¼šæ¯ä¸ªå­å±‚ï¼ˆæ³¨æ„åŠ›ã€å‰é¦ˆï¼‰å‰åéƒ½æœ‰

### 2. ä½ç½®ç¼–ç  (Positional Encoding)

**é—®é¢˜**ï¼šTransformer æœ¬èº«ä¸åŒ…å«ä½ç½®ä¿¡æ¯

**è§£å†³æ–¹æ¡ˆ**ï¼šRoPE (Rotary Position Embedding)

**Qwen2.5-Coder ä½¿ç”¨**ï¼š
- `rope_theta = 1000000.0`
- æ—‹è½¬ä½ç½®ç¼–ç ï¼Œæ›´å¥½åœ°å¤„ç†é•¿åºåˆ—

### 3. KV Cache æœºåˆ¶ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼Œä¸å½±å“åŠŸèƒ½ï¼‰

**é—®é¢˜**ï¼šæ¯æ¬¡ç”Ÿæˆæ–° token æ—¶ï¼Œå¦‚æœé‡æ–°è®¡ç®—æ•´ä¸ªåºåˆ—ï¼Œæ•ˆç‡å¾ˆä½

**è§£å†³æ–¹æ¡ˆ**ï¼šKV Cacheï¼ˆè¿™æ˜¯æ€§èƒ½ä¼˜åŒ–ï¼Œä¸å½±å“"è¾“å…¥â†’è¾“å‡º"çš„åŠŸèƒ½ï¼‰

**åŸç†**ï¼š
```
ç¬¬ 1 æ¬¡æ¨ç†:
è¾“å…¥: [token1, token2, token3]
è®¡ç®—: K1, V1, K2, V2, K3, V3
ç¼“å­˜: Cache = {K1, V1, K2, V2, K3, V3}

ç¬¬ 2 æ¬¡æ¨ç†:
è¾“å…¥: [token4]  (åªè¾“å…¥æ–° token)
ä½¿ç”¨ç¼“å­˜: Cache
è®¡ç®—: K4, V4
æ›´æ–°ç¼“å­˜: Cache = {K1, V1, K2, V2, K3, V3, K4, V4}
```

**å½“å‰å®ç°çŠ¶æ€**ï¼š
- âŒ æœªå®ç° KV Cache
- âš ï¸ æ¯æ¬¡æ¨ç†éƒ½ä¼ å…¥å®Œæ•´åºåˆ—
- ğŸ”„ æœªæ¥éœ€è¦å®ç°ä»¥æ”¯æŒçœŸæ­£çš„å¢é‡ç”Ÿæˆ

### 4. ç”Ÿæˆç­–ç•¥

#### å½“å‰å®ç°ï¼šArgmax

**åŸç†**ï¼šé€‰æ‹©æ¦‚ç‡æœ€é«˜çš„ token

**ä¼˜ç‚¹**ï¼š
- ç®€å•ã€å¿«é€Ÿ
- ç¡®å®šæ€§å¼ºï¼ˆç›¸åŒè¾“å…¥ â†’ ç›¸åŒè¾“å‡ºï¼‰

**ç¼ºç‚¹**ï¼š
- å¯èƒ½ç”Ÿæˆé‡å¤å†…å®¹
- ç¼ºä¹åˆ›é€ æ€§

#### æœªæ¥æ”¹è¿›æ–¹å‘

**Temperature Sampling**ï¼š
```rust
let probs = softmax(logits / temperature);
let next_token = sample_from_distribution(probs);
```

- `temperature < 1.0`ï¼šæ›´ä¿å®ˆï¼Œé€‰æ‹©é«˜æ¦‚ç‡ token
- `temperature > 1.0`ï¼šæ›´éšæœºï¼Œå¢åŠ åˆ›é€ æ€§

**Top-K Sampling**ï¼š
```rust
let top_k_logits = get_top_k(logits, k=50);
let next_token = sample_from(top_k_logits);
```

- åªä»æ¦‚ç‡æœ€é«˜çš„ K ä¸ª token ä¸­é€‰æ‹©

**Top-P (Nucleus) Sampling**ï¼š
```rust
let cumulative_probs = cumulative_sum(sorted_probs);
let top_p_tokens = take_while(cumulative_probs < p);
let next_token = sample_from(top_p_tokens);
```

- ä»ç´¯ç§¯æ¦‚ç‡è¾¾åˆ° P çš„ token é›†åˆä¸­é€‰æ‹©

---

## åè¯è§£é‡Š

### åŸºç¡€æ¦‚å¿µ

#### Tokenï¼ˆè¯å…ƒï¼‰

**å®šä¹‰**ï¼šæ¨¡å‹å¤„ç†æ–‡æœ¬çš„åŸºæœ¬å•ä½

**ç±»å‹**ï¼š
- **å•è¯çº§**ï¼š`"feat"`, `"æ·»åŠ "`, `"åŠŸèƒ½"`
- **å­—ç¬¦çº§**ï¼š`"f"`, `"e"`, `"a"`, `"t"`
- **å­è¯çº§**ï¼ˆBPEï¼‰ï¼š`"feat"`, `": "`, `"æ·»åŠ "`

**ç¤ºä¾‹**ï¼š
```
æ–‡æœ¬: "feat: æ·»åŠ æ–°åŠŸèƒ½"
Tokens: ["feat", ":", "æ·»åŠ ", "æ–°", "åŠŸèƒ½"]
Token IDs: [1234, 5678, 9012, 3456, 7890]
```

#### Tokenizationï¼ˆåˆ†è¯ï¼‰

**å®šä¹‰**ï¼šå°†æ–‡æœ¬è½¬æ¢ä¸º token åºåˆ—çš„è¿‡ç¨‹

**æ–¹æ³•**ï¼š
- **BPE (Byte Pair Encoding)**ï¼šQwen2.5-Coder ä½¿ç”¨
- **WordPiece**ï¼šBERT ä½¿ç”¨
- **SentencePiece**ï¼šT5 ä½¿ç”¨

#### Embeddingï¼ˆåµŒå…¥ï¼‰

**å®šä¹‰**ï¼šå°†ç¦»æ•£çš„ token ID è½¬æ¢ä¸ºè¿ç»­çš„å‘é‡è¡¨ç¤º

**è¿‡ç¨‹**ï¼š
```
Token ID: 1234
    â†“ æŸ¥æ‰¾åµŒå…¥è¡¨
Embedding Vector: [0.1, -0.3, 0.5, ..., 0.2]  (ç»´åº¦: 896)
```

**ä½œç”¨**ï¼šè®©æ¨¡å‹èƒ½å¤Ÿè¿›è¡Œæ•°å­¦è¿ç®—ï¼ˆå‘é‡åŠ å‡ã€ç‚¹ç§¯ç­‰ï¼‰

#### Logitsï¼ˆæ¨¡å‹è®¡ç®—çš„å¾—åˆ†ï¼‰

**å®šä¹‰**ï¼šæ¨¡å‹"æ¨ç†"åè¾“å‡ºçš„åŸå§‹åˆ†æ•°ï¼ˆæ¯ä¸ªå¯èƒ½å•è¯çš„å¾—åˆ†ï¼‰

**é€šä¿—ç†è§£**ï¼š
- æ¨¡å‹è®¡ç®—åï¼Œå¯¹æ¯ä¸ªå¯èƒ½çš„å•è¯éƒ½ç»™å‡ºäº†ä¸€ä¸ª"å¾—åˆ†"
- å¾—åˆ†è¶Šé«˜ï¼Œè¶Šå¯èƒ½æ˜¯æ­£ç¡®ç­”æ¡ˆ
- å°±åƒè€ƒè¯•è¯„åˆ†ï¼šæ¯ä¸ªé€‰é¡¹éƒ½æœ‰åˆ†æ•°ï¼Œé€‰å¾—åˆ†æœ€é«˜çš„

**å½¢çŠ¶**ï¼š`[batch_size, seq_len, vocab_size]`

**ç¤ºä¾‹**ï¼š
```
å¯¹äºä½ç½® 140ï¼Œæ¨¡å‹è®¡ç®—åç»™å‡ºæ¯ä¸ªå•è¯çš„å¾—åˆ†ï¼š
logits[0, 140, :] = [0.1, -2.3, 5.7, ..., 3.2]
                     â†‘    â†‘     â†‘         â†‘
                   "a"  "the" "feat"   "fix"

å¾—åˆ†æœ€é«˜çš„æ˜¯ "feat" (5.7)ï¼Œæ‰€ä»¥æ¨¡å‹é€‰æ‹©å®ƒ

ç»è¿‡ softmax è½¬æ¢ä¸ºæ¦‚ç‡ï¼š
probs = [0.0001, 0.0001, 0.85, ..., 0.02]
         â†‘       â†‘       â†‘          â†‘
       "a"     "the"   "feat"     "fix"

"feat" çš„æ¦‚ç‡æ˜¯ 0.85ï¼ˆ85%ï¼‰ï¼Œæ‰€ä»¥é€‰æ‹©å®ƒ
```

#### Softmax

**å®šä¹‰**ï¼šå°† logits è½¬æ¢ä¸ºæ¦‚ç‡åˆ†å¸ƒ

**å…¬å¼**ï¼š
```
softmax(x_i) = exp(x_i) / Î£ exp(x_j)
```

**ä½œç”¨**ï¼šç¡®ä¿æ‰€æœ‰æ¦‚ç‡ä¹‹å’Œä¸º 1

#### Argmax

**å®šä¹‰**ï¼šè¿”å›æœ€å¤§å€¼çš„ç´¢å¼•

**ç¤ºä¾‹**ï¼š
```
logits = [0.1, -2.3, 5.7, 3.2]
argmax(logits) = 2  (ç´¢å¼• 2 çš„å€¼æœ€å¤§)
```

### æ¨¡å‹ç›¸å…³

#### Transformer

**å®šä¹‰**ï¼šä¸€ç§åŸºäºæ³¨æ„åŠ›æœºåˆ¶çš„ç¥ç»ç½‘ç»œæ¶æ„

**ç‰¹ç‚¹**ï¼š
- å¹¶è¡Œå¤„ç†ï¼ˆç›¸æ¯” RNN çš„ä¸²è¡Œï¼‰
- é•¿è·ç¦»ä¾èµ–ï¼ˆæ³¨æ„åŠ›æœºåˆ¶ï¼‰
- å¯æ‰©å±•æ€§å¼ºï¼ˆå †å æ›´å¤šå±‚ï¼‰

#### Self-Attentionï¼ˆè‡ªæ³¨æ„åŠ›ï¼‰

**å®šä¹‰**ï¼šè®¡ç®—åºåˆ—ä¸­æ¯ä¸ªä½ç½®ä¸å…¶ä»–æ‰€æœ‰ä½ç½®çš„å…³è”åº¦

**å…¬å¼**ï¼š
```
Attention(Q, K, V) = softmax(QK^T / âˆšd_k) V
```

**ç¤ºä¾‹**ï¼š
```
è¾“å…¥: ["feat", ":", "æ·»åŠ ", "åŠŸèƒ½"]
      â†“
"æ·»åŠ " å…³æ³¨ "feat" (æƒé‡: 0.6)
"æ·»åŠ " å…³æ³¨ ":" (æƒé‡: 0.1)
"æ·»åŠ " å…³æ³¨ "åŠŸèƒ½" (æƒé‡: 0.3)
      â†“
è¾“å‡º: 0.6 * embedding("feat") + 0.1 * embedding(":") + 0.3 * embedding("åŠŸèƒ½")
```

#### KV Cacheï¼ˆé”®å€¼ç¼“å­˜ï¼‰

**å®šä¹‰**ï¼šç¼“å­˜æ³¨æ„åŠ›æœºåˆ¶ä¸­çš„ Key å’Œ Value å‘é‡ï¼Œé¿å…é‡å¤è®¡ç®—

**ä¼˜åŠ¿**ï¼š
- åŠ é€Ÿæ¨ç†ï¼ˆåªè®¡ç®—æ–° tokenï¼‰
- å‡å°‘å†…å­˜å ç”¨ï¼ˆå¤ç”¨ç¼“å­˜ï¼‰

**å½“å‰çŠ¶æ€**ï¼šâŒ æœªå®ç°ï¼ˆæœªæ¥æ”¹è¿›æ–¹å‘ï¼‰

### æ–‡ä»¶æ ¼å¼

#### Safetensors

**å®šä¹‰**ï¼šä¸€ç§å®‰å…¨çš„å¼ é‡å­˜å‚¨æ ¼å¼

**ç‰¹ç‚¹**ï¼š
- **å®‰å…¨**ï¼šä¸æ‰§è¡Œä»£ç ï¼ˆç›¸æ¯” Pickleï¼‰
- **å¿«é€Ÿ**ï¼šæ”¯æŒå†…å­˜æ˜ å°„
- **è·¨è¯­è¨€**ï¼šRustã€Pythonã€JavaScript éƒ½æ”¯æŒ

**ç»“æ„**ï¼š
```
{
  "metadata": {...},
  "tensors": {
    "layer.0.weight": <binary data>,
    "layer.1.weight": <binary data>,
    ...
  }
}
```

#### GGUF

**å®šä¹‰**ï¼šå¦ä¸€ç§æ¨¡å‹å­˜å‚¨æ ¼å¼ï¼ˆæ—§æ ¼å¼ï¼Œå·²å¼ƒç”¨ï¼‰

**ç‰¹ç‚¹**ï¼š
- ç”± llama.cpp é¡¹ç›®ä½¿ç”¨
- æ”¯æŒé‡åŒ–ï¼ˆé™ä½ç²¾åº¦ä»¥å‡å°æ–‡ä»¶å¤§å°ï¼‰

**å½“å‰çŠ¶æ€**ï¼šâš ï¸ ä»…å…¼å®¹ï¼Œå»ºè®®ä½¿ç”¨ Safetensors

### Git ç›¸å…³

#### Porcelain Format

**å®šä¹‰**ï¼šGit å‘½ä»¤çš„ç¨³å®šè¾“å‡ºæ ¼å¼ï¼ˆä¾›è„šæœ¬è§£æï¼‰

**æ ¼å¼**ï¼š
```
XY filename
```

**çŠ¶æ€ç **ï¼š
- `X`ï¼šæš‚å­˜åŒºçŠ¶æ€ï¼ˆA/M/D/Rï¼‰
- `Y`ï¼šå·¥ä½œåŒºçŠ¶æ€ï¼ˆM/D/Tï¼‰

#### Filter-Branch

**å®šä¹‰**ï¼šGit å‘½ä»¤ï¼Œç”¨äºæ‰¹é‡é‡å†™å†å²

**åŸç†**ï¼š
- å¯¹æ¯ä¸ªæäº¤åº”ç”¨è¿‡æ»¤å™¨è„šæœ¬
- æ ¹æ®è„šæœ¬è¾“å‡ºæ›¿æ¢ commit message

**ç¤ºä¾‹**ï¼š
```bash
git filter-branch --msg-filter 'echo "new message"' HEAD~5..HEAD
```

---

## ä½¿ç”¨æŒ‡å—

### å®‰è£…æ¨¡å‹

#### æ­¥éª¤ 1: ä¸‹è½½æ¨¡å‹æ–‡ä»¶

ä» Hugging Face ä¸‹è½½ Qwen2.5-Coder-0.5B-Instructï¼š

```bash
# åˆ›å»ºæ¨¡å‹ç›®å½•
mkdir -p ~/.cyber-zen/models/default_qwen2-5

# ä¸‹è½½æ–‡ä»¶ï¼ˆéœ€è¦å®‰è£… huggingface-cliï¼‰
huggingface-cli download Qwen/Qwen2.5-Coder-0.5B-Instruct \
  --local-dir ~/.cyber-zen/models/default_qwen2-5 \
  --local-dir-use-symlinks False
```

**å¿…éœ€æ–‡ä»¶**ï¼š
- `model.safetensors` (988MB)
- `config.json` (659 bytes)
- `tokenizer.json` (å‡  MB)

#### æ­¥éª¤ 2: éªŒè¯æ–‡ä»¶

```bash
ls -lh ~/.cyber-zen/models/default_qwen2-5/
# åº”è¯¥çœ‹åˆ°ï¼š
# - model.safetensors (çº¦ 988M)
# - config.json (çº¦ 659 bytes)
# - tokenizer.json (çº¦å‡  MB)
```

### åŸºæœ¬ä½¿ç”¨

#### ç”Ÿæˆæ–°æäº¤çš„ Commit Message

```bash
# 1. ä¿®æ”¹ä¸€äº›æ–‡ä»¶
echo "æ–°åŠŸèƒ½" > new_feature.rs
git add new_feature.rs

# 2. è¿è¡Œ gcm-ai
cyber-zen gcm-ai

# 3. æŸ¥çœ‹ç”Ÿæˆçš„ messageï¼Œç¡®è®¤åæäº¤
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
âœ“ æ‰¾åˆ°æ¨¡å‹æ–‡ä»¶: /Users/robert/.cyber-zen/models/default_qwen2-5/model.safetensors
æ­£åœ¨ä½¿ç”¨ AI ç”Ÿæˆæäº¤ä¿¡æ¯...
 æ£€æµ‹åˆ° Git å˜æ›´...

ğŸ“ æ–‡ä»¶å˜æ›´çŠ¶æ€:
  âœ¨ æ–°å¢: new_feature.rs

 å˜æ›´ç»Ÿè®¡:
  æ–°å¢æ–‡ä»¶: 1 ä¸ª
  ä¿®æ”¹æ–‡ä»¶: 0 ä¸ª
  åˆ é™¤æ–‡ä»¶: 0 ä¸ª
  æ€»å˜æ›´: 1 ä¸ªæ–‡ä»¶

æ­£åœ¨åŠ è½½æœ¬åœ°æ¨¡å‹...
âœ“ æ¨¡å‹åŠ è½½æˆåŠŸ
æ­£åœ¨ç”Ÿæˆæ–‡æœ¬...

 ç”Ÿæˆçš„ AI Commit Message:
feat: æ›´æ–°ä»£ç 

- ä¿®å¤æ¨¡å‹æ¨ç†é—®é¢˜
- å®Œå–„é”™è¯¯å¤„ç†æœºåˆ¶

æ˜¯å¦ä½¿ç”¨æ­¤æ¶ˆæ¯? [Y/n] y
```

#### é‡å†™å†å²æäº¤

```bash
# é‡å†™æœ€è¿‘ 5 ä¸ªæäº¤
cyber-zen gcm-ai --rewrite --max-commits 5

# é¢„è§ˆæ¨¡å¼ï¼ˆä¸å®é™…ä¿®æ”¹ï¼‰
cyber-zen gcm-ai --rewrite --max-commits 5 --dry-run
```

**æ³¨æ„äº‹é¡¹**ï¼š
- âš ï¸ ä¼šåˆ›å»ºå¤‡ä»½åˆ†æ”¯
- âš ï¸ å¦‚æœå·²æ¨é€åˆ°è¿œç¨‹ï¼Œéœ€è¦ä½¿ç”¨ `git push --force-with-lease`

#### æŒ‡å®šæ¨¡å‹

```bash
# ä½¿ç”¨æŒ‡å®šçš„æ¨¡å‹
cyber-zen gcm-ai --model my-custom-model
```

**æ¨¡å‹æŸ¥æ‰¾è§„åˆ™**ï¼š
1. `~/.cyber-zen/models/my-custom-model/model.safetensors`
2. `~/.cyber-zen/models/my-custom-model.safetensors`

### é«˜çº§é…ç½®

#### æ¨¡å‹ç›®å½•ç»“æ„

```
~/.cyber-zen/models/
â”œâ”€â”€ default_qwen2-5/          # é»˜è®¤æ¨¡å‹ï¼ˆç›®å½•å½¢å¼ï¼‰
â”‚   â”œâ”€â”€ model.safetensors
â”‚   â”œâ”€â”€ config.json
â”‚   â””â”€â”€ tokenizer.json
â”‚
â”œâ”€â”€ default_another-model.safetensors  # é»˜è®¤æ¨¡å‹ï¼ˆæ–‡ä»¶å½¢å¼ï¼‰
â”‚
â””â”€â”€ custom-model/              # è‡ªå®šä¹‰æ¨¡å‹
    â”œâ”€â”€ model.safetensors
    â”œâ”€â”€ config.json
    â””â”€â”€ tokenizer.json
```

#### é…ç½®æ–‡ä»¶ä½ç½®

```
~/.cyber-zen/configs/
â”œâ”€â”€ file-types.toml      # æ–‡ä»¶ç±»å‹å®šä¹‰
â”œâ”€â”€ categories.toml      # ç›®å½•åˆ†ç±»è§„åˆ™
â””â”€â”€ commit-templates.toml # Commit æ¨¡æ¿
```

---

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. "æ¨¡å‹æ–‡ä»¶ä¸å­˜åœ¨"

**é”™è¯¯ä¿¡æ¯**ï¼š
```
æœªæ‰¾åˆ°é»˜è®¤æ¨¡å‹æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥ä»¥ä¸‹ä½ç½®ï¼š
  1. ~/.cyber-zen/models/default_*/model.safetensors
  2. ~/.cyber-zen/models/default_*.safetensors
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®è®¤æ¨¡å‹æ–‡ä»¶å·²ä¸‹è½½åˆ°æ­£ç¡®ä½ç½®
2. æ£€æŸ¥æ–‡ä»¶åæ˜¯å¦ä»¥ `default_` å¼€å¤´
3. éªŒè¯æ–‡ä»¶æƒé™ï¼ˆå¯è¯»ï¼‰

#### 2. "æ— æ³•è¯»å– config.json"

**é”™è¯¯ä¿¡æ¯**ï¼š
```
æ— æ³•è¯»å– config.json (os error 2)
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®è®¤ `config.json` å­˜åœ¨äºæ¨¡å‹ç›®å½•
2. æ£€æŸ¥æ–‡ä»¶æƒé™
3. éªŒè¯ JSON æ ¼å¼æ˜¯å¦æ­£ç¡®

#### 3. "æ¨¡å‹æ¨ç†å¤±è´¥: shape mismatch"

**é”™è¯¯ä¿¡æ¯**ï¼š
```
shape mismatch in broadcast_add, lhs: [1, 14, 139, 277], rhs: [1, 1, 139, 139]
```

**åŸå› **ï¼š
- æ¨¡å‹åœ¨"è®¡ç®—"ï¼ˆæ¨ç†ï¼‰è¿‡ç¨‹ä¸­ï¼Œå†…éƒ¨æ•°æ®å½¢çŠ¶ä¸åŒ¹é…
- è¿™æ˜¯æŠ€æœ¯å®ç°é—®é¢˜ï¼Œä¸æ˜¯"æ¨ç†"è¿™ä¸ªæ¦‚å¿µçš„é—®é¢˜
- å°±åƒè®¡ç®—å™¨å†…éƒ¨ç”µè·¯å‡ºé”™äº†ï¼Œä¸æ˜¯"è®¡ç®—"è¿™ä¸ªæ¦‚å¿µçš„é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**ï¼š
- å½“å‰ç‰ˆæœ¬ä½¿ç”¨å›ºå®šæ¨¡æ¿ä½œä¸ºä¸´æ—¶æ–¹æ¡ˆ
- æœªæ¥ç‰ˆæœ¬å°†ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼Œå®ç°çœŸæ­£çš„"è¾“å…¥â†’è¾“å‡º"

#### 4. "æ²¡æœ‰æ£€æµ‹åˆ° Git å˜æ›´"

**é”™è¯¯ä¿¡æ¯**ï¼š
```
æ²¡æœ‰æ£€æµ‹åˆ° Git å˜æ›´
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®è®¤æœ‰æœªæš‚å­˜æˆ–æœªæäº¤çš„æ›´æ”¹
2. è¿è¡Œ `git status` æŸ¥çœ‹å½“å‰çŠ¶æ€
3. ä½¿ç”¨ `git add` æ·»åŠ æ–‡ä»¶åˆ°æš‚å­˜åŒº

#### 5. "å½“å‰ç›®å½•ä¸æ˜¯ Git ä»“åº“"

**é”™è¯¯ä¿¡æ¯**ï¼š
```
å½“å‰ç›®å½•ä¸æ˜¯ Git ä»“åº“
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. åœ¨ Git ä»“åº“æ ¹ç›®å½•è¿è¡Œå‘½ä»¤
2. æˆ–ä½¿ç”¨ `git init` åˆå§‹åŒ–ä»“åº“

### è°ƒè¯•æŠ€å·§

#### å¯ç”¨è¯¦ç»†æ—¥å¿—

å½“å‰ä»£ç å·²åŒ…å«å¤§é‡è°ƒè¯•è¾“å‡ºï¼š
- æ¨¡å‹åŠ è½½æ­¥éª¤
- Token æ•°é‡
- Logits å½¢çŠ¶
- ç”Ÿæˆè¿›åº¦

#### æ£€æŸ¥æ¨¡å‹æ–‡ä»¶å®Œæ•´æ€§

```bash
# æ£€æŸ¥æ–‡ä»¶å¤§å°
ls -lh ~/.cyber-zen/models/default_qwen2-5/

# éªŒè¯ JSON æ ¼å¼
cat ~/.cyber-zen/models/default_qwen2-5/config.json | jq .

# æµ‹è¯• tokenizer
python -c "from tokenizers import Tokenizer; t = Tokenizer.from_file('tokenizer.json'); print(t.encode('test'))"
```

#### æµ‹è¯•æ¨¡å‹åŠ è½½

```rust
// åœ¨ Rust ä»£ç ä¸­æ·»åŠ æµ‹è¯•
#[test]
fn test_model_loading() {
    let model_path = PathBuf::from("~/.cyber-zen/models/default_qwen2-5/model.safetensors");
    let model = CandleModel::load_from_path(&model_path).unwrap();
    println!("æ¨¡å‹åŠ è½½æˆåŠŸï¼");
}
```

---

## æœªæ¥æ”¹è¿›æ–¹å‘

### 1. å®ç°å®Œæ•´çš„æ–‡æœ¬ç”Ÿæˆ

**å½“å‰çŠ¶æ€**ï¼šè¿”å›å›ºå®šæ¨¡æ¿

**æ”¹è¿›è®¡åˆ’**ï¼š
- å®ç° KV Cache æœºåˆ¶
- æ”¯æŒå¢é‡ token ç”Ÿæˆ
- æ·»åŠ é‡‡æ ·ç­–ç•¥ï¼ˆTemperature, Top-K, Top-Pï¼‰

### 2. æ€§èƒ½ä¼˜åŒ–

**è®¡åˆ’**ï¼š
- GPU æ”¯æŒï¼ˆCUDA/Metalï¼‰
- é‡åŒ–æ¨¡å‹ï¼ˆé™ä½ç²¾åº¦ï¼Œå‡å°æ–‡ä»¶å¤§å°ï¼‰
- æ‰¹å¤„ç†ï¼ˆä¸€æ¬¡å¤„ç†å¤šä¸ªè¯·æ±‚ï¼‰

### 3. åŠŸèƒ½å¢å¼º

**è®¡åˆ’**ï¼š
- æ”¯æŒå¤šæ¨¡å‹åˆ‡æ¢
- è‡ªå®šä¹‰ Prompt æ¨¡æ¿
- å†å²è®°å½•ä¿å­˜
- æ‰¹é‡å¤„ç†å¤šä¸ªä»“åº“

---

## å‚è€ƒèµ„æ–™

### å®˜æ–¹æ–‡æ¡£

- [Candle æ–‡æ¡£](https://github.com/huggingface/candle)
- [Qwen2.5-Coder æ¨¡å‹](https://huggingface.co/Qwen/Qwen2.5-Coder-0.5B-Instruct)
- [Conventional Commits è§„èŒƒ](https://www.conventionalcommits.org/)

### æŠ€æœ¯è®ºæ–‡

- [Attention Is All You Need (Transformer)](https://arxiv.org/abs/1706.03762)
- [RoPE: Rotary Position Embedding](https://arxiv.org/abs/2104.09864)

### ç›¸å…³é¡¹ç›®

- [git-rewrite-commits](https://github.com/f/git-rewrite-commits)
- [Candle Examples](https://github.com/huggingface/candle/tree/main/candle-examples)

---

## æ€»ç»“

`gcm-ai` æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„ AI å¢å¼º Git å·¥å…·ï¼Œå®ƒï¼š

1. **æœ¬åœ°è¿è¡Œ**ï¼šå®Œå…¨ç¦»çº¿ï¼Œä¿æŠ¤éšç§
2. **æ™ºèƒ½åˆ†æ**ï¼šè‡ªåŠ¨ç†è§£ä»£ç å˜æ›´
3. **è§„èŒƒè¾“å‡º**ï¼šç”Ÿæˆç¬¦åˆ Conventional Commits çš„ message
4. **çµæ´»é…ç½®**ï¼šæ”¯æŒå¤šæ¨¡å‹ã€è‡ªå®šä¹‰é…ç½®

è™½ç„¶å½“å‰ç‰ˆæœ¬åœ¨æ–‡æœ¬ç”Ÿæˆæ–¹é¢ä½¿ç”¨ç®€åŒ–å®ç°ï¼Œä½†æ•´ä½“æ¶æ„å·²ç»æ­å»ºå®Œæˆï¼Œä¸ºæœªæ¥çš„åŠŸèƒ½æ‰©å±•æ‰“ä¸‹äº†åšå®åŸºç¡€ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼š1.0  
**æœ€åæ›´æ–°**ï¼š2024-01-02  
**ç»´æŠ¤è€…**ï¼šCyber Zen Tools å›¢é˜Ÿ

